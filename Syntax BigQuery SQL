-- Membuat tabel analitik baru di dataset kimia_farma
CREATE TABLE `kimia_farma.kimia_farma_analytics` AS
SELECT 
    ft.transaction_id,  -- ID transaksi dari tabel transaksi final
    ft.date,  -- Tanggal transaksi
    ft.branch_id,  -- ID cabang tempat transaksi dilakukan
    kc.branch_name,  -- Nama cabang
    kc.kota,  -- Kota lokasi cabang
    kc.provinsi,  -- Provinsi lokasi cabang
    kc.rating AS rating_cabang,  -- Rating cabang
    ft.customer_name,  -- Nama pelanggan
    p.product_id,  -- ID produk
    p.product_name,  -- Nama produk
    p.price AS actual_price,  -- Harga asli produk
    ft.discount_percentage,  -- Persentase diskon yang diberikan

    -- Menghitung persentase laba kotor berdasarkan harga produk
    CASE
        WHEN p.price <= 50000 THEN 0.1
        WHEN p.price BETWEEN 50000 AND 100000 THEN 0.15
        WHEN p.price BETWEEN 100000 AND 300000 THEN 0.2
        WHEN p.price BETWEEN 300000 AND 500000 THEN 0.25
        WHEN p.price > 500000 THEN 0.3
    END AS persentase_gross_laba,

    -- Menghitung penjualan bersih (harga setelah diskon)
    (p.price * (1 - ft.discount_percentage)) AS nett_sales,

    -- Menghitung laba bersih (penjualan bersih dikalikan persentase laba kotor)
    (p.price * (1 - ft.discount_percentage) *
    CASE
        WHEN p.price <= 50000 THEN 0.1
        WHEN p.price BETWEEN 50000 AND 100000 THEN 0.15
        WHEN p.price BETWEEN 100000 AND 300000 THEN 0.2
        WHEN p.price BETWEEN 300000 AND 500000 THEN 0.25
        ELSE 0.3
    END) AS nett_profit

FROM
    kimia_farma.kf_final_transaction AS ft  -- Tabel transaksi utama
JOIN
    kimia_farma.kf_kantor_cabang AS kc  -- Tabel data cabang
    ON ft.branch_id = kc.branch_id  -- Join berdasarkan ID cabang
JOIN
    kimia_farma.kf_product AS p  -- Tabel data produk
    ON ft.product_id = p.product_id;  -- Join berdasarkan ID produk
